<%
/** 
* @description Tanstack Query - Query 생성 템플릿 입니다.
*/

const { utils, route, modelTypes, config } = it;

const { moduleName, routes } = route;

const queryRoutes = routes.filter(({ request: { method } }) => method === 'get');
const moduleConfig = routes.at(0)?.moduleConfig;
const codegenConfig = routes.at(0)?.codegenConfig;

const { pathInfo } = codegenConfig.customOutput;
const resolveRelativeImportPath = moduleConfig.utils.resolveRelativeImportPath({
  fromPath: pathInfo.queries.output.relative
})
%>

<% if (queryRoutes?.length) { %>
import { useQuery, useSuspenseQuery, queryOptions } from '@tanstack/react-query';
import type { DefaultError, UseQueryOptions, UseSuspenseQueryOptions } from '@tanstack/react-query';
import type { KyInstance, Options } from 'ky';

<%~ includeFile('../imports/dto-import.ejs', { ...it, codegenConfig, resolveRelativeImportPath }) %>

<%~ includeFile('../imports/api-class.ejs', { ...it, moduleConfig, codegenConfig, resolveRelativeImportPath }) %>
<%~ includeFile('../imports/api-instance.ejs', { ...it, moduleConfig, codegenConfig, resolveRelativeImportPath }) %>


export const <%~ moduleConfig.query.queryKeyObjectName %> = {
<% for (const {queryMeta, hookConfig: {query}} of queryRoutes) { %>
<%~ query.queryKeyConstanstName %>: <% ~query.queryKeyConstanstFunction %>,
<% } %>
}

const queries = {
<% for (const route of queryRoutes) { const {queryMeta, routeConfig, hookConfig: {query}}=route; const
    routeDocs=includeFile("../route-docs.ejs", { config, route: route, utils }); 
%>
/**
<%~ routeDocs.lines %>
*
*/
<% ~routeConfig.request.functionName %>: ({ <%~ routeConfig.request.parameters.arguments.all.join(", ") %> }: <% ~moduleConfig.apiParametersTypeName %>["<%~ routeConfig.request.functionName %>"]) => queryOptions({
    queryKey: <%~ moduleConfig.query.queryKeyObjectName %>.<% ~query.queryKeyConstanstName %>(<% ~query.queryKeyArgs %>),
    queryFn: () => <% ~moduleConfig.apiInstanceName %>.<% ~routeConfig.request.functionName %>({<% ~routeConfig.request.parameters.arguments.all.join(", ") %>})
}),
<% } %>
}

export { queries as <%~ moduleName %>Queries };

// ---------------------- Query ------------------------------
<% for (const route of queryRoutes) {
    const routeDocs = includeFile("../route-docs.ejs", { config, route: route, utils });
    const query = route.hookConfig.query;
    const routeConfig = route.routeConfig;
    const hasRequestArgs = routeConfig.request.parameters.signatures.required.length > 0;
%>
/**
<%~ routeDocs.lines %>
*
*/
export const <%~ query.queryHookName %> = <TData=<%~ routeConfig.response.dtoName %>>(
    requestArgs: Parameters<typeof queries.<%~ routeConfig.request.functionName %>>[0]<%~ hasRequestArgs ? '' : ' = {}' %>,
    options?: Omit<Parameters<typeof queryOptions<<%~ routeConfig.response.dtoName %>, Error, TData, ReturnType<typeof <%~ moduleConfig.query.queryKeyObjectName %>.<%~ query.queryKeyConstanstName %>>>>[0],'queryKey' | 'queryFn'>
) => {
    return useQuery({
        ...queries.<% ~routeConfig.request.functionName %>(requestArgs),
        ...options,
        select: options?.select,
    })
}

<% } %>

// ------------------ Suspense Query --------------------------
<% for (const route of queryRoutes) {
    const routeDocs = includeFile("../route-docs.ejs", { config, route: route, utils });
    const query = route.hookConfig.query;
    const routeConfig = route.routeConfig;
    const hasRequestArgs = routeConfig.request.parameters.signatures.required.length > 0;
%>
/**
<%~ routeDocs.lines %>
*
*/
export const <%~ query.suspenseQueryHookName %> = <TData=<%~ routeConfig.response.dtoName %>>(
    requestArgs: Parameters<typeof queries.<%~ routeConfig.request.functionName %>>[0]<%~ hasRequestArgs ? '' : ' = {}' %>,
    options?: Omit<Parameters<typeof queryOptions<<%~ routeConfig.response.dtoName %>, Error, TData, ReturnType<typeof <%~ moduleConfig.query.queryKeyObjectName %>.<%~ query.queryKeyConstanstName %>>>>[0],'queryKey' | 'queryFn'>
) => {
    return useSuspenseQuery({
        ...queries.<% ~routeConfig.request.functionName %>(requestArgs),
        ...options,
        select: options?.select,
    })
}

    <% } %>
<% } %>