<%
/** 
* @description Tanstack Query - Mutation 생성 템플릿 입니다.
*/

const { utils, route, modelTypes, config } = it;
const { pascalCase } = utils;
const { moduleName, routes } = route;

const mutationKeyRoutes = routes
    .filter(({ request: { method } }) => ['post','patch','put','delete'].includes(method));
const mutationRoutes = mutationKeyRoutes.filter(({ response }) => !response.contentTypes?.includes('text/event-stream'));

const commonMeta = mutationRoutes.at(0)?.customeMeta;
const moduleConfig = routes.at(0)?.moduleConfig;
const codegenConfig = routes.at(0)?.codegenConfig;

const { pathInfo } = codegenConfig.customOutput;
const resolveRelativeImportPath = moduleConfig.utils.resolveRelativeImportPath({
  fromPath: pathInfo.mutations.output.relative
})
%>

<% if (mutationRoutes?.length) { %>
import type {DefaultError, UseMutationOptions } from '@tanstack/react-query';
import { useQueryClient, useMutation } from '@tanstack/react-query';
import type { KyInstance, Options } from 'ky';

<%~ includeFile('../imports/dto-import.ejs', { ...it, codegenConfig, resolveRelativeImportPath }) %>

<%~ includeFile('../imports/api-class.ejs', { ...it, moduleConfig, codegenConfig, resolveRelativeImportPath }) %>
<%~ includeFile('../imports/api-instance.ejs', { ...it, moduleConfig, codegenConfig, resolveRelativeImportPath }) %>
<%~ includeFile('../imports/query.ejs', { ...it, moduleConfig, codegenConfig, resolveRelativeImportPath }) %>


export const <% ~moduleConfig.mutation.mutationKeyObjectName %> = {
<% for (const {hookConfig: {mutation}} of mutationKeyRoutes) { %>
    <% ~mutation.mutationKeyConstanstName %>: <% ~mutation.mutationKeyConstanstContent %>,
<% } %>
};

const mutations = {
<% for (const {customeMeta, routeConfig, hookConfig: {mutation}} of mutationRoutes) { %>
    <%= routeConfig.request.functionName %>: () => ({
        mutationFn:({ <%= routeConfig.request.parameters.arguments.all.join(", ") %> }: <%= moduleConfig.apiParametersTypeName %>["<%= routeConfig.request.functionName %>"]) => {
            return <%= moduleConfig.apiInstanceName %>.<%= routeConfig.request.functionName %>({<%= routeConfig.request.parameters.arguments.all.join(", ") %>});
        },
        mutationKey: <% ~moduleConfig.mutation.mutationKeyObjectName %>.<% ~mutation.mutationKeyConstanstName %>,
    }),
<% } %>
};

export { mutations as <%~ moduleName %>Mutations };

<% for (const route of mutationRoutes) {
    const routeDocs = includeFile("../route-docs.ejs", { config, route, utils });
    const mutation = route.hookConfig.mutation;
    const routeConfig = route.routeConfig;
%>

/**
<%~ routeDocs.lines %>

*/
export const <%= mutation.mutationHookName %> = (
    options?: Omit<UseMutationOptions<<%~ routeConfig.response.dtoName %>,DefaultError, <%= moduleConfig.apiParametersTypeName %>["<%= routeConfig.request.functionName %>"]>,'mutationFn'|'mutationKey' >
) => {
    <% if (mutation.invalidateQueryKey.length) { %>
    const queryClient = useQueryClient();
    <% } %>

    return useMutation({
        ...mutations.<%= routeConfig.request.functionName %>(),
        ...options,
        <% if (mutation.invalidateQueryKey.length) { %>
        onSuccess: (data, variables, context) => {
            <% for (const invalidateQueryKey of mutation.invalidateQueryKey) { %>
            queryClient.invalidateQueries({ queryKey: <%~ `${moduleConfig.query.queryKeyObjectName}.${invalidateQueryKey}` %>, exact: true });
            <% } %>

            options?.onSuccess?.(data, variables, context);
        },
        <% } %>
    });
};

<% } %>
<% } %>