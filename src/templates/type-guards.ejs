<%
/** 
* @description Type Guard 생성 템플릿 입니다.
*/

const { modelTypes, utils, config, routes } = it;
const { pascalCase, internalCase: camelCase } = utils;

const contractList = modelTypes
    .filter((contract) => contract.name !== 'HTTPValidationErrorDto')
    .map((contract) => {
    return {
        functionName: camelCase(`is${contract.name}`),
        dtoName: contract.name,
        schemaName: camelCase(`${contract.name}Schema`)
    }
})

const parameterDtoList = routes.combined.map((route) => {
    return route.routes.reduce((acc, api) => {
      const isQueryConentExsist = Boolean(api.specificArgs.query?.type);
      const isHeaderConentExsist = Boolean(api.specificArgs.headers?.type);

      const queryName = `${pascalCase(api.routeName.usage)}QueryParams`;
      const headerName = `${pascalCase(api.routeName.usage)}Headers`;

      isQueryConentExsist && acc.push({
        functionName: camelCase(`is${queryName}`),
        dtoName: queryName,
        schemaName: camelCase(`${queryName}Schema`)
      })
      isHeaderConentExsist && acc.push({
        functionName: camelCase(`is${headerName}`),
        dtoName: headerName,
        schemaName: camelCase(`${headerName}Schema`)
      })

      return acc;
    }, [])
}).flat();

const allDtoList = [...contractList, ...parameterDtoList];

const allRouteDependencies = routes.combined;
const flatRoute = allRouteDependencies.reduce((acc, v) => {
  acc.routes.push(...v.routes);
  return acc;
}, {routes: []});

const firstRoute = allRouteDependencies.at(0)
const moduleConfig = firstRoute.routes.at(0)?.moduleConfig;
const codegenConfig = firstRoute.routes.at(0)?.codegenConfig;

const resolveRelativeImportPath = moduleConfig.utils.resolveRelativeImportPath({
  fromPath: codegenConfig.customOutput.pathInfo.typeGuards.output.relative
})

const { pathInfo } = codegenConfig.customOutput;

//TODO: 모든 라우트에 대해 생성되도록 해야함
%>

<%~ includeFile('./imports/dto-import.ejs', { route: flatRoute, utils, modelTypes, codegenConfig, resolveRelativeImportPath }) %>
<%~ includeFile('./imports/schema-import.ejs', { route: flatRoute, contractList, utils, modelTypes, codegenConfig, resolveRelativeImportPath }) %>


<% for (const parameterDto of allDtoList) { %>
export const <%~ parameterDto.functionName %> = (
  data: unknown,
): data is <%~ parameterDto.dtoName %> => {
  return <%~ parameterDto.schemaName %>.safeParse(data).success;
};


<% } %>

