<%
const { utils, route, config } = it;
const { _, pascalCase } = utils;
const routeDocs = includeFile("./route-docs", { config, route, utils });

const functionName = route.request.method + pascalCase(`${route.request.path
        .split('/')
        .map((segment) =>
                segment.includes('${') ? `By_${segment.replace(/[${}]/g, '')}` : segment
        )
        .filter(segment => !['api', 'v1'].includes(segment.toLowerCase()))
        .join('_')}`);

const responseType = route.responseBodyInfo?.success?.type || 'any';
const pathParams = _.values(route.request.parameters);
const hasPathParams = pathParams.length > 0;
const payload = route.request.payload;
const query = route.request.query;
const method = route.request.method.toLowerCase();
const isDataMethod = method === 'post' || method === 'put' || method === 'patch';

// Swagger 스펙에서 multipart/form-data 요청인지 확인
const isMultipartRequest = route.raw?.requestBody?.content?.['multipart/form-data'];

const queryTypeName = query ? `${pascalCase(route.routeName.usage.replace('ApiV1', ''))}QueryParams` : null;

const generateParams = (params, query, payload) => {
    const paramList = [
        ...(params ? params.map(param => `${param.name}${param.optional ? '?' : ''}: ${param.type}`) : []),
        ...(payload ? [`payload${payload.optional ? '?' : ''}: ${payload.type.replace('ApiV1', '')}`] : []),
        ...(query ? [`params${query.optional ? '?' : ''}: ${queryTypeName || query.type}`] : []),
        'config?: AxiosRequestConfig'
    ];

    return paramList.join(', ');
};
const path = route.request.path.replace(/{/g, '{').replace(/}/g, '}').slice(1,).replace(/^api\/v1\//, '')
const unAuthorizedPathList = ['auth/primary', 'auth/secondary', 'users/email', "users/${userId}/password"]
const isSignUp = route.request.method.toLowerCase() === 'post' && path === 'users'
const isUnAuthorized = unAuthorizedPathList.some(p => path.includes(p)) || isSignUp

const getAxiosInstance = () => {
    if (isUnAuthorized) return 'unAuthorizedAxiosInstance';
    if (isMultipartRequest) return 'multiDataAxiosInstance';
    return 'axiosInstance';
};
%>

/**
<%~ routeDocs.lines %> */
<%= functionName %>: async (<%~ generateParams(pathParams, query, payload) %>) => {
const response = await <%= getAxiosInstance() %>.<%= method %><<%= responseType %>>(`<%= path %>`,
<% if (isDataMethod) { %>
    <%= payload ? 'payload' : 'undefined' %>,
<% } %>
    {
        <%= query ? 'params,' : '' %>
        <%= !isDataMethod && payload ? 'data: payload,' : '' %>
        ...config
    }
)
return response.data;
},
